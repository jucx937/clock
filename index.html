<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>班級鬧鐘 - 最終穩定版</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background-color: #f0f2f5; margin: 0; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; width: 350px; }
        .time-display { font-size: 3.5rem; font-weight: bold; color: #1a73e8; margin-bottom: 20px; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        button { background-color: #1a73e8; color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        #status { font-size: 0.9rem; color: #666; margin-top: 10px; border: 1px dashed #ccc; padding: 5px; }
        .alarm-active { background-color: #ea4335 !important; animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

<div class="container">
    <h2>班級鬧鐘</h2>
    <div id="clock" class="time-display">00:00:00</div>
    
    <label>設定時間：</label>
    <input type="time" id="alarmTime" step="1">
    
    <label>響鈴長度：</label>
    <select id="duration">
        <option value="5">5 秒</option>
        <option value="10">10 秒</option>
        <option value="30">30 秒</option>
    </select>
    
    <button id="startBtn" onclick="initSystem()">點擊啟動系統</button>
    <div id="status">狀態：等待授權</div>
    <button style="background-color: #666; margin-top: 20px;" onclick="testSound()">測試鈴聲/語音</button>
</div>

<audio id="audioPlayer" src="alert.mp3" preload="auto"></audio>

<script>
    let alarmTime = "";
    let isRunning = false;
    let hasTriggered = false;

    // 預設為現在時間
    const now = new Date();
    document.getElementById('alarmTime').value = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0') + ":00";

    function initSystem() {
        isRunning = true;
        alarmTime = document.getElementById('alarmTime').value;
        document.getElementById('status').innerText = `監控中：${alarmTime} 響鈴`;
        document.getElementById('startBtn').innerText = "系統運行中 (請勿關閉網頁)";
        document.getElementById('startBtn').style.backgroundColor = "#34a853";
        
        // 嘗試解鎖音訊
        const audio = document.getElementById('audioPlayer');
        audio.play().then(() => { audio.pause(); audio.currentTime = 0; });
        speak("鬧鐘系統已啟動");
    }

    function speak(text) {
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'zh-TW';
        window.speechSynthesis.speak(msg);
    }

    function testSound() {
        speak("測試音訊與語音");
        const audio = document.getElementById('audioPlayer');
        audio.play();
        setTimeout(() => { audio.pause(); audio.currentTime = 0; }, 2000);
    }

    function checkTime() {
        const now = new Date();
        const h = now.getHours().toString().padStart(2, '0');
        const m = now.getMinutes().toString().padStart(2, '0');
        const s = now.getSeconds().toString().padStart(2, '0');
        const currentTime = `${h}:${m}:${s}`;
        
        document.getElementById('clock').innerText = currentTime;

        if (!isRunning) return;

        // 寬鬆比對：只要「分」對了，且該分鐘還沒響過
        const settingHM = alarmTime.substring(0, 5);
        const currentHM = currentTime.substring(0, 5);

        if (currentHM === settingHM && !hasTriggered) {
            playAlarm();
        }

        if (currentHM !== settingHM) {
            hasTriggered = false;
        }
    }

    function playAlarm() {
        hasTriggered = true;
        const audio = document.getElementById('audioPlayer');
        const sec = document.getElementById('duration').value;
        
        document.body.classList.add('alarm-active');
        
        // 同時執行：播放語音標題 + 鈴聲
        speak("鬧鐘響了，請注意時間");
        audio.loop = true;
        audio.play().catch(e => console.log("音訊播放失敗，改用語音補償"));

        setTimeout(() => {
            audio.pause();
            audio.currentTime = 0;
            document.body.classList.remove('alarm-active');
        }, sec * 1000);
    }

    setInterval(checkTime, 500);
</script>
</body>
</html>
