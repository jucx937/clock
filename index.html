<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç­ç´šé¬§é˜ç³»çµ± - é€²éšæ§åˆ¶ç‰ˆ</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #eef2f7; display: flex; justify-content: center; padding: 20px; }
        .container { background: white; width: 450px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .time-now { font-size: 3.5rem; text-align: center; font-weight: bold; color: #1a73e8; margin-bottom: 20px; }
        .setup-box { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #dee2e6; }
        .input-group { margin-bottom: 10px; }
        label { display: block; font-size: 0.9rem; margin-bottom: 5px; color: #555; }
        input, select, button { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        .btn { border: none; cursor: pointer; font-weight: bold; font-size: 1rem; margin-top: 5px; }
        .btn-system { background-color: #1a73e8; color: white; }
        .btn-add { background-color: #34a853; color: white; }
        .btn-stop { background-color: #dc3545; color: white; display: none; padding: 15px; font-size: 1.2rem; }
        .alarm-item { background: #fff; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .active-alarm { animation: blink 0.5s infinite; }
        @keyframes blink { 50% { background-color: #ffcccc; } }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center;">ç­ç´šé¬§é˜ç³»çµ±</h2>
    <div id="clock" class="time-now">00:00:00</div>

    <button id="systemBtn" class="btn btn-system" onclick="toggleSystem()">1. é»æ“Šæˆæ¬Šè²éŸ³ä¸¦å•Ÿå‹•ç³»çµ±</button>
    <button id="stopBtn" class="btn btn-stop" onclick="stopAlarm()">ğŸ›‘ ç«‹å³é—œé–‰é¬§é˜</button>

    <div class="setup-box">
        <div class="input-group">
            <label>è¨­å®šé¬§é˜åç¨±ï¼š</label>
            <input type="text" id="alarmName" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€ç¯€ä¸‹èª²">
        </div>
        <div class="input-group">
            <label>è¨­å®šæ™‚é–“ (æ™‚:åˆ†)ï¼š</label>
            <input type="time" id="newTime">
        </div>
        <div class="input-group">
            <label>éŸ¿éˆ´é•·åº¦ï¼š</label>
            <select id="durationSelect">
                <option value="5">5 ç§’</option>
                <option value="10">10 ç§’</option>
                <option value="15">15 ç§’</option>
                <option value="20">20 ç§’</option>
            </select>
        </div>
        <div class="input-group">
            <label>é¸æ“‡éˆ´è²ï¼š</label>
            <select id="soundSelect">
                <option value="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3">æ¨™æº–é›»å­éŸ³</option>
                <option value="https://assets.mixkit.co/active_storage/sfx/1017/1017-preview.mp3">æ¸…è„†é˜è²</option>
                <option value="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3">å¿«ç¯€å¥è­¦å ±</option>
                <option value="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3">æŸ”å’Œæç¤ºéŸ³</option>
            </select>
        </div>
        <button class="btn btn-add" onclick="addAlarm()">+ æ–°å¢é¬§é˜</button>
    </div>

    <div id="alarmList"></div>
</div>

<audio id="globalPlayer"></audio>

<script>
    let alarms = JSON.parse(localStorage.getItem('classAlarms')) || [];
    let isSystemActive = false;
    let alarmTimer = null; // ç”¨ä¾†æ§åˆ¶è‡ªå‹•åœæ­¢çš„è¨ˆæ™‚å™¨

    setInterval(updateClock, 1000);
    renderAlarms();

    function updateClock() {
        const now = new Date();
        const h = now.getHours().toString().padStart(2, '0');
        const m = now.getMinutes().toString().padStart(2, '0');
        const s = now.getSeconds().toString().padStart(2, '0');
        const currentTime = `${h}:${m}:${s}`;
        document.getElementById('clock').innerText = currentTime;

        if (isSystemActive) {
            checkAlarms(h, m);
        }
    }

    function toggleSystem() {
        isSystemActive = true;
        document.getElementById('systemBtn').innerText = "âœ… ç³»çµ±ç›£æ§ä¸­...";
        document.getElementById('systemBtn').style.backgroundColor = "#34a853";
        // è§£é–éŸ³è¨Š
        const audio = document.getElementById('globalPlayer');
        audio.src = "https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3";
        audio.play().then(() => { audio.pause(); });
    }

    function addAlarm() {
        const time = document.getElementById('newTime').value;
        const name = document.getElementById('alarmName').value || "é¬§é˜";
        const sound = document.getElementById('soundSelect').value;
        const duration = document.getElementById('durationSelect').value;
        if (!time) return alert("è«‹è¨­å®šæ™‚é–“");
        
        alarms.push({ time, name, sound, duration, hasTriggered: false });
        saveAndRender();
    }

    function checkAlarms(h, m) {
        const currentHM = `${h}:${m}`;
        alarms.forEach(alarm => {
            if (currentHM === alarm.time && !alarm.hasTriggered) {
                triggerAlarm(alarm);
            }
            if (currentHM !== alarm.time) {
                alarm.hasTriggered = false; 
            }
        });
    }

    function triggerAlarm(alarm) {
        alarm.hasTriggered = true;
        const audio = document.getElementById('globalPlayer');
        audio.src = alarm.sound;
        audio.loop = true;
        audio.play();
        
        document.getElementById('stopBtn').style.display = "block";
        document.body.classList.add('active-alarm');

        // è¨­å®šè‡ªå‹•åœæ­¢è¨ˆæ™‚å™¨
        alarmTimer = setTimeout(() => {
            stopAlarm();
        }, alarm.duration * 1000);

        // è·³å‡ºæç¤ºè¦–çª—
        setTimeout(() => {
            if (confirm(`â° é¬§é˜éŸ¿äº†ï¼š${alarm.name}\né è¨ˆéŸ¿éˆ´ ${alarm.duration} ç§’\né»æ“Šã€Œç¢ºå®šã€å¯ç«‹å³é—œé–‰`)) {
                stopAlarm();
            }
        }, 100);
    }

    function stopAlarm() {
        // æ¸…é™¤è‡ªå‹•åœæ­¢è¨ˆæ™‚å™¨ï¼Œé¿å…é‡è¤‡åŸ·è¡Œ
        if (alarmTimer) clearTimeout(alarmTimer);
        
        const audio = document.getElementById('globalPlayer');
        audio.pause();
        audio.currentTime = 0;
        document.getElementById('stopBtn').style.display = "none";
        document.body.classList.remove('active-alarm');
    }

    function deleteAlarm(index) {
        alarms.splice(index, 1);
        saveAndRender();
    }

    function saveAndRender() {
        localStorage.setItem('classAlarms', JSON.stringify(alarms));
        renderAlarms();
    }

    function renderAlarms() {
        const list = document.getElementById('alarmList');
        list.innerHTML = "";
        alarms.sort((a,b) => a.time.localeCompare(b.time)).forEach((alarm, index) => {
            const item = document.
