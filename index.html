<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç­ç´šèªéŸ³é¬§é˜ç³»çµ±</title>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f4f7f9; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { background: white; width: 400px; padding: 25px; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); text-align: center; }
        .clock { font-size: 3.5rem; font-weight: bold; color: #1a73e8; margin: 20px 0; background: #e8f0fe; border-radius: 10px; padding: 10px; line-height: 1.2; }
        .setup-group { background: #fafafa; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eee; text-align: left; }
        label { display: block; font-size: 0.85rem; color: #666; margin-bottom: 5px; }
        input, select, button { width: 100%; padding: 12px; margin-top: 5px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-size: 1rem; }
        .btn-system { background: #1a73e8; color: white; border: none; cursor: pointer; font-weight: bold; }
        .btn-add { background: #34a853; color: white; border: none; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-stop { background: #d93025; color: white; border: none; cursor: pointer; font-weight: bold; display: none; margin-top: 15px; padding: 15px; }
        .alarm-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .flash-bg { animation: alert-flash 0.5s infinite; }
        @keyframes alert-flash { 50% { background-color: #f8d7da; } }
    </style>
</head>
<body onclick="unlockAudio()">

<div class="container">
    <h2>ç­ç´šèªéŸ³é¬§é˜ç³»çµ±</h2>
    <div id="liveClock" class="clock">00:00:00</div>
    
    <button id="authBtn" class="btn-system" onclick="startSystem()">1. å•Ÿå‹•ç³»çµ±ä¸¦æˆæ¬ŠèªéŸ³</button>
    <button id="stopBtn" class="btn-stop" onclick="killAlarm()">ğŸ›‘ ç«‹å³é—œé–‰éˆ´è²/èªéŸ³</button>

    <div class="setup-group">
        <label>é¬§é˜æ¨™é¡Œ (æœƒå”¸å‡ºä¾†)ï¼š</label>
        <input type="text" id="alarmName" placeholder="ä¾‹å¦‚ï¼šå„ä½è€å¸«åŒå­¸ï¼Œæ‰“æƒæ™‚é–“åˆ°äº†">
        <label>æ™‚é–“ (æ™‚:åˆ†)ï¼š</label>
        <input type="time" id="alarmTime">
        <label>éŸ¿éˆ´é•·åº¦ (èªéŸ³å”¸å®Œå¾Œé–‹å§‹è¨ˆæ™‚)ï¼š</label>
        <select id="alarmDuration">
            <option value="5">5 ç§’</option>
            <option value="10">10 ç§’</option>
            <option value="15">15 ç§’</option>
            <option value="20">20 ç§’</option>
        </select>
        <button class="btn-add" onclick="addNewAlarm()">+ æ–°å¢èªéŸ³é¬§é˜</button>
    </div>

    <div id="alarmListArea"></div>
</div>

<audio id="audioElement" loop></audio>

<script>
    let alarms = JSON.parse(localStorage.getItem('savedAlarms')) || [];
    let isMonitoring = false;
    let autoStopTimer = null;

    // å•Ÿå‹•æ™‚é–“é¡¯ç¤º
    setInterval(tick, 500);
    updateUI();

    function tick() {
        const now = new Date();
        const timeStr = now.toTimeString().split(' ')[0];
        document.getElementById('liveClock').innerText = timeStr;

        if (isMonitoring) {
            const currentHM = timeStr.substring(0, 5);
            alarms.forEach(a => {
                if (currentHM === a.time && !a.triggeredToday) {
                    executeAlarm(a);
                }
                if (currentHM !== a.time) a.triggeredToday = false;
            });
        }
    }

    function startSystem() {
        isMonitoring = true;
        const btn = document.getElementById('authBtn');
        btn.innerText = "âœ… ç›£æ§ä¸­ (èªéŸ³åŠŸèƒ½å·²æº–å‚™)";
        btn.style.background = "#34a853";
        unlockAudio();
        speak("é¬§é˜ç³»çµ±å·²å°±ç·’");
    }

    function unlockAudio() {
        const a = document.getElementById('audioElement');
        a.src = "https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3";
        a.play().then(() => { a.pause(); a.currentTime = 0; });
    }

    function speak(text, callback) {
        // å…ˆåœæ­¢ä¹‹å‰çš„èªéŸ³ï¼Œé¿å…é‡ç–Š
        window.speechSynthesis.cancel();
        
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'zh-TW';
        msg.rate = 0.9; // èªé€Ÿç¨å¾®æ”¾æ…¢ä¸€é»æ›´æ¸…æ¥š
        
        if (callback) {
            msg.onend = callback;
        }
        
        window.speechSynthesis.speak(msg);
    }

    function addNewAlarm() {
        const t = document.getElementById('alarmTime').value;
        const n = document.getElementById('alarmName').value || "æ™‚é–“åˆ°äº†";
        const d = document.getElementById('alarmDuration').value;
        if (!t) return alert("è«‹è¨­å®šæ™‚é–“ï¼");
        alarms.push({ time: t, name: n, duration: d, triggeredToday: false });
        saveAndRefresh();
    }

    function executeAlarm(alarm) {
        alarm.triggeredToday = true;
        document.body.classList.add('flash-bg');
        document.getElementById('stopBtn').style.display = "block";

        let count = 0;
        const repeatSpeak = () => {
            if (count < 3) {
                count++;
                speak(alarm.name, repeatSpeak);
            } else {
                // æ¨™é¡Œå”¸å®Œ 3 æ¬¡å¾Œï¼Œé–‹å§‹æ’­æ”¾éˆ´è²
                startRinging(alarm.duration);
            }
        };

        repeatSpeak();
    }

    function startRinging(duration) {
        const player = document.getElementById('audioElement');
        player.play();
        
        // è¨­å®šéˆ´è²æ’­æ”¾çš„è‡ªå‹•åœæ­¢æ™‚é–“
        autoStopTimer = setTimeout(killAlarm, duration * 1000);
    }

    function killAlarm() {
        // åœæ­¢èªéŸ³
        window.speechSynthesis.cancel();
        // åœæ­¢éˆ´è²
        if (autoStopTimer) clearTimeout(autoStopTimer);
        const player = document.getElementById('audioElement');
        player.pause();
        player.currentTime = 0;
        
        document.body.classList.remove('flash-bg');
        document.getElementById('stopBtn').style.display = "none";
    }

    function deleteAlarm(index) {
        alarms.splice(index, 1);
        saveAndRefresh();
    }

    function saveAndRefresh() {
        localStorage.setItem('savedAlarms', JSON.stringify(alarms));
        updateUI();
    }

    function updateUI() {
        const container = document.getElementById('alarmListArea');
        container.innerHTML = "";
        alarms.sort((a,b) => a.time.localeCompare(b.time)).forEach((a, i) => {
            const div = document.createElement('div');
            div.className = 'alarm-item';
            div.innerHTML = `<span><b>${a.time}</b> - ${a.name}</span>
                             <button onclick="deleteAlarm(${i})" style="width:auto; background:none; color:red; border:none; cursor:pointer;">åˆªé™¤</button>`;
            container.appendChild(div);
        });
    }
</script>
</body>
</html>
