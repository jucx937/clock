<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>穩定版班級鬧鐘測試</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background-color: #f0f2f5; margin: 0; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; width: 350px; }
        .time-display { font-size: 3rem; font-weight: bold; color: #1a73e8; margin-bottom: 20px; }
        .setup-area { border-top: 1px solid #eee; pt: 20px; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        button { background-color: #1a73e8; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:active { background-color: #1557b0; }
        #status { font-size: 0.9rem; color: #666; margin-top: 10px; }
        .alarm-active { background-color: #ea4335 !important; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.7; } }
    </style>
</head>
<body>

<div class="container">
    <h2>班級鬧鐘 (測試版)</h2>
    <div id="clock" class="time-display">00:00:00</div>
    
    <div class="setup-area">
        <label>設定鬧鐘時間：</label>
        <input type="time" id="alarmTime" step="1">
        
        <label>響鈴長度：</label>
        <select id="duration">
            <option value="5">5 秒</option>
            <option value="10">10 秒</option>
            <option value="15">15 秒</option>
            <option value="30">30 秒</option>
        </select>
        
        <button id="startBtn" onclick="activateContext()">1. 點擊授權聲音並啟動</button>
        <div id="status">狀態：等待授權</div>
    </div>
</div>

<audio id="audioPlayer" src="https://actions.google.com/sounds/v1/alarms/alarm_clock_beep.ogg" preload="auto"></audio>

<script>
    let alarmTime = "";
    let isActive = false;
    let hasTriggered = false; // 關鍵標記：確保該分鐘只響一次，不漏響

    // 2. 預設值設定為現在時間
    window.onload = () => {
        const now = new Date();
        const timeInput = document.getElementById('alarmTime');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        timeInput.value = `${hours}:${minutes}`;
    };

    // 4. 避開音訊權限失效：點擊按鈕才正式啟動
    function activateContext() {
        document.getElementById('audioPlayer').play().then(() => {
            document.getElementById('audioPlayer').pause();
            document.getElementById('audioPlayer').currentTime = 0;
            
            isActive = true;
            alarmTime = document.getElementById('alarmTime').value;
            document.getElementById('status').innerText = `狀態：監控中 (${alarmTime})`;
            document.getElementById('startBtn').innerText = "鬧鐘設定成功！";
            document.getElementById('startBtn').style.backgroundColor = "#34a853";
        }).catch(e => {
            alert("請先點擊頁面任何地方以允許聲音播放");
        });
    }

    function checkAlarm() {
        const now = new Date();
        const currentH = String(now.getHours()).padStart(2, '0');
        const currentM = String(now.getMinutes()).padStart(2, '0');
        const currentTimeString = `${currentH}:${currentM}`;
        
        // 顯示更新
        document.getElementById('clock').innerText = now.toLocaleTimeString('zh-TW', { hour12: false });

        if (!isActive) return;

        // 4. 避開嚴格比對：改用「時間已到」且「尚未響過」判斷
        if (currentTimeString === alarmTime && !hasTriggered) {
            triggerAlarm();
        }

        // 換分鐘時重置標記，準備下次響鈴
        if (currentTimeString !== alarmTime) {
            hasTriggered = false;
        }
    }

    function triggerAlarm() {
        hasTriggered = true;
        const player = document.getElementById('audioPlayer');
        const duration = parseInt(document.getElementById('duration').value) * 1000;
        
        document.body.classList.add('alarm-active');
        player.loop = true;
        player.play();

        // 1. 鬧鐘響鈴長度設定
        setTimeout(() => {
            player.pause();
            player.currentTime = 0;
            document.body.classList.remove('alarm-active');
            document.getElementById('status').innerText = "鬧鐘結束，等待下次重置";
        }, duration);
    }

    // 解決分頁節流：改用較短頻率檢查，確保在 1 秒的誤差內一定能捕捉到
    setInterval(checkAlarm, 500);

</script>
</body>
</html>