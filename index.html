<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>班級鬧鐘 - 修正版</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background-color: #f0f2f5; margin: 0; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; width: 350px; }
        .time-display { font-size: 3rem; font-weight: bold; color: #1a73e8; margin-bottom: 20px; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        button { background-color: #1a73e8; color: white; border: none; cursor: pointer; font-weight: bold; }
        #status { font-size: 0.9rem; color: #666; margin-top: 10px; }
        .alarm-active { background-color: #ea4335 !important; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.7; } }
    </style>
</head>
<body>

<div class="container">
    <h2>班級鬧鐘 (穩定修正版)</h2>
    <div id="clock" class="time-display">00:00:00</div>
    
    <label>設定時間：</label>
    <input type="time" id="alarmTime" step="1">
    
    <label>響鈴長度：</label>
    <select id="duration">
        <option value="5">5 秒</option>
        <option value="10">10 秒</option>
        <option value="30">30 秒</option>
    </select>
    
    <button id="startBtn" onclick="startAlarmSystem()">啟動鬧鐘系統</button>
    <div id="status">狀態：尚未啟動 (請點擊按鈕)</div>
</div>

<audio id="audioPlayer" src="https://actions.google.com/sounds/v1/alarms/alarm_clock_beep.ogg" preload="auto"></audio>

<script>
    let alarmTime = "";
    let isRunning = false;
    let hasTriggered = false;

    // 自動填入現在時間
    const now = new Date();
    document.getElementById('alarmTime').value = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0') + ":00";

    function startAlarmSystem() {
        // 點擊瞬間播放並立即暫停，藉此取得瀏覽器音訊授權
        const audio = document.getElementById('audioPlayer');
        audio.play().then(() => {
            audio.pause();
            audio.currentTime = 0;
            
            alarmTime = document.getElementById('alarmTime').value;
            isRunning = true;
            document.getElementById('status').innerText = `監控中：將於 ${alarmTime} 響鈴`;
            document.getElementById('startBtn').innerText = "系統運行中...";
            document.getElementById('startBtn').style.backgroundColor = "#34a853";
        }).catch(err => {
            alert("請再點擊一次按鈕以授權聲音！");
        });
    }

    function checkTime() {
        const now = new Date();
        const timeStr = now.toTimeString().split(' ')[0]; // 格式 HH:mm:ss
        document.getElementById('clock').innerText = timeStr;

        if (!isRunning) return;

        // 比對時間 (HH:mm:ss)
        if (timeStr === alarmTime && !hasTriggered) {
            playAlarm();
        }

        if (timeStr !== alarmTime) {
            hasTriggered = false;
        }
    }

    function playAlarm() {
        hasTriggered = true;
        const audio = document.getElementById('audioPlayer');
        const sec = document.getElementById('duration').value;
        
        document.body.classList.add('alarm-active');
        audio.loop = true;
        audio.play();

        setTimeout(() => {
            audio.pause();
            audio.currentTime = 0;
            document.body.classList.remove('alarm-active');
        }, sec * 1000);
    }

    setInterval(checkTime, 500);
</script>
</body>
</html>
