<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç­ç´šé¬§é˜ - ç©©å®šæ¢å¾©ç‰ˆ</title>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f0f4f8; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { background: white; width: 1000px; max-width: 95vw; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); text-align: center; }
        .clock { font-size: 3.5rem; font-weight: bold; color: #1a73e8; margin-bottom: 20px; background: #e8f0fe; border-radius: 15px; padding: 15px; display: inline-block; min-width: 300px; }
        
        .setup-group { background: #fafafa; padding: 20px; border-radius: 15px; border: 1px solid #eee; text-align: left; margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto; }
        label { display: block; font-size: 0.85rem; color: #666; margin-top: 10px; font-weight: bold; }
        input, select, button { width: 100%; padding: 12px; margin-top: 5px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 1rem; }
        .btn-main { background: #1a73e8; color: white; border: none; font-weight: bold; cursor: pointer; height: 50px; }
        .btn-add { background: #34a853; color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .btn-stop { background: #d93025; color: white; border: none; font-weight: bold; display: none; padding: 20px; font-size: 1.5rem; margin-top: 15px; border-radius: 10px; }
        .sound-row { display: flex; gap: 8px; align-items: flex-end; }
        .btn-listen { flex: 1; background: #6c757d; color: white; border: none; cursor: pointer; height: 42px; border-radius: 8px; }

        /* æ ¼å­æ¸…å–®æ’ç‰ˆ */
        #alarmListArea { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }

        .alarm-item { 
            text-align: left; padding: 20px; background: #fff; border: 1px solid #e8f0fe; border-radius: 15px; position: relative; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: all 0.3s ease; 
        }
        /* æ¨™é¡Œè¦åœ¨æ™‚é–“å‰é¢ä¸”åŠ å¤§ */
        .alarm-title { font-size: 1.6rem; font-weight: bold; color: #333; margin-bottom: 5px; display: block; }
        .alarm-time { font-size: 1.4rem; font-weight: bold; color: #1a73e8; margin-bottom: 10px; display: block; }
        
        .tag { display: inline-block; background: #f0f4f8; color: #555; padding: 2px 8px; border-radius: 5px; font-size: 0.75rem; margin-right: 5px; margin-top: 5px; border: 1px solid #ddd; }

        /* éŸ¿éå¾Œçš„è®Šè‰²ç‹€æ…‹ */
        .alarm-item.done { background: #f0f0f0; opacity: 0.7; border-color: #ccc; }
        .alarm-item.done .alarm-title { text-decoration: line-through; color: #888; }
        .alarm-item.done .alarm-time { color: #888; }

        .delete-btn { position: absolute; right: 15px; top: 15px; color: #bbb; border: none; background: none; cursor: pointer; font-size: 1.2rem; width: auto; padding: 5px; }
        .delete-btn:hover { color: #d93025; }

        .flash-bg { animation: alert-flash 0.4s infinite; }
        @keyframes alert-flash { 50% { background-color: #ff3333; color: white; } }

        @media (max-width: 800px) { #alarmListArea { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 500px) { #alarmListArea { grid-template-columns: 1fr; } }
    </style>
</head>
<body onclick="unlockAudio()">

<div class="container">
    <h2 id="mainTitle">ç­ç´šé¬§é˜ç³»çµ±</h2>
    <div id="liveClock" class="clock">00:00:00</div>
    
    <div style="margin-bottom: 20px;">
        <button id="authBtn" class="btn-main" style="width: 300px;" onclick="startMonitoring()">1. é»æ“Šå•Ÿå‹•ç›£æ§ç³»çµ±</button>
        <button id="stopBtn" class="btn-stop" onclick="killAlarm()">ğŸ›‘ åœæ­¢éŸ¿éˆ´ / èªéŸ³</button>
    </div>

    <div class="setup-group">
        <label>1. é¬§é˜æ¨™é¡Œï¼š</label>
        <input type="text" id="alarmName" placeholder="ä¾‹å¦‚ï¼šæ‰“æƒæ™‚é–“åˆ°äº†">
        
        <label>2. æ™‚é–“èˆ‡æ’­æ”¾æ–¹å¼ï¼š</label>
        <div style="display:flex; gap:10px;">
            <input type="time" id="alarmTime" style="flex:1.5">
            <select id="playMode" style="flex:2">
                <option value="seq">å…ˆèªéŸ³ â” å¾Œéˆ´è²</option>
                <option value="sim">èªéŸ³èˆ‡éˆ´è²åŒæ™‚æ’­æ”¾</option>
            </select>
        </div>

        <label>3. é‡è¤‡é€±æœŸèˆ‡é•·åº¦ï¼š</label>
        <div style="display:flex; gap:10px;">
            <select id="repeatSelect" style="flex:2">
                <option value="once">åƒ…ä¸€æ¬¡</option>
                <option value="daily">æ¯å¤©</option>
                <option value="weekday">å¹³æ—¥ (é€±ä¸€è‡³äº”)</option>
                <option value="weekend">é€±æœ« (é€±å…­ã€æ—¥)</option>
                <option value="mon">æ¯é€±ä¸€</option><option value="tue">æ¯é€±äºŒ</option>
                <option value="wed">æ¯é€±ä¸‰</option><option value="thu">æ¯é€±å››</option>
                <option value="fri">æ¯é€±äº”</option><option value="sat">æ¯é€±å…­</option>
                <option value="sun">æ¯é€±æ—¥</option>
            </select>
            <select id="alarmDuration" style="flex:1">
                <option value="5">5ç§’</option>
                <option value="10">10ç§’</option>
                <option value="20">20ç§’</option>
                <option value="30">30ç§’</option>
            </select>
        </div>

        <label>4. é¸æ“‡éˆ´è²ï¼š</label>
        <div class="sound-row">
            <select id="soundSelect" style="flex:2.5; height:42px;">
                <option value="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3">æ¨™æº–é›»å­éŸ³</option>
                <option value="https://assets.mixkit.co/active_storage/sfx/1017/1017-preview.mp3">æ¸…è„†é˜è²</option>
                <option value="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3">å¿«ç¯€å¥è­¦å ±</option>
                <option value="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3">æŸ”å’Œæç¤ºéŸ³</option>
                <option value="https://assets.mixkit.co/active_storage/sfx/1003/1003-preview.mp3">å¾©å¤é›»è©±éŸ³</option>
            </select>
            <button class="btn-listen" onclick="previewSound()">ğŸ”Š è©¦è½</button>
        </div>

        <button class="btn-add" onclick="addNewAlarm()">+ æ–°å¢é¬§é˜</button>
    </div>

    <div id="alarmListArea"></div>
</div>

<audio id="bellPlayer" loop crossorigin="anonymous"></audio>

<script>
    let alarms = JSON.parse(localStorage.getItem('savedAlarms')) || [];
    let isMonitoring = false;
    let autoStopTimer = null;
    let lastDate = new Date().getDate();

    // æ™‚é˜ä¸»è¿´åœˆ
    setInterval(() => {
        const now = new Date();
        const timeStr = now.toTimeString().split(' ')[0];
        document.getElementById('liveClock').innerText = timeStr;

        // æ¯æ—¥é‡ç½®è§¸ç™¼ç‹€æ…‹
        if (now.getDate() !== lastDate) {
            lastDate = now.getDate();
            alarms.forEach(a => a.triggeredToday = false);
            saveData();
        }

        if (isMonitoring) {
            const currentHM = timeStr.substring(0, 5);
            alarms.forEach((a, index) => {
                if (currentHM === a.time && !a.triggeredToday && isCorrectDay(a.repeat, now.getDay())) {
                    startAlarm(a, index);
                }
            });
        }
    }, 1000);

    function isCorrectDay(mode, day) {
        if (mode === 'once' || mode === 'daily') return true;
        if (mode === 'weekday') return day >= 1 && day <= 5;
        if (mode === 'weekend') return day === 0 || day === 6;
        const map = { sun: 0, mon: 1, tue: 2, wed: 3, thu: 4, fri: 5, sat: 6 };
        return map[mode] === day;
    }

    function startMonitoring() {
        isMonitoring = true;
        document.getElementById('authBtn').innerText = "âœ… ç›£æ§ç³»çµ±é‹è¡Œä¸­";
        document.getElementById('authBtn').style.background = "#34a853";
        updateUI();
        speak("ç³»çµ±å•Ÿå‹•");
    }

    function startAlarm(alarm, index) {
        alarm.triggeredToday = true;
        updateUI(); // ç«‹å³è®Šç°

        document.body.classList.add('flash-bg');
        document.getElementById('stopBtn').style.display = "block";
        
        const bp = document.getElementById('bellPlayer');
        bp.src = alarm.sound;
        bp.loop = true;

        let count = 0;
        const playVoice = () => {
            if (count < 3) {
                count++;
                speak(alarm.name, playVoice);
            } else if (alarm.playMode === 'seq') {
                bp.play();
                setTimer(alarm, index);
            }
        };

        if (alarm.playMode === 'sim') {
            bp.play();
            playVoice();
            setTimer(alarm, index);
        } else {
            playVoice();
        }
    }

    function setTimer(alarm, index) {
        if (autoStopTimer) clearTimeout(autoStopTimer);
        autoStopTimer = setTimeout(() => {
            killAlarm();
            if (alarm.repeat === 'once') {
                alarms.splice(index, 1);
            }
            saveData();
        }, alarm.duration * 1000);
    }

    function killAlarm() {
        window.speechSynthesis.cancel();
        if (autoStopTimer) clearTimeout(autoStopTimer);
        const bp = document.getElementById('bellPlayer');
        bp.pause();
        bp.currentTime = 0;
        document.body.classList.remove('flash-bg');
        document.getElementById('stopBtn').style.display = "none";
    }

    function speak(text, callback) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'zh-TW';
        if (callback) msg.onend = callback;
        window.speechSynthesis.speak(msg);
    }

    function previewSound() {
        const bp = document.getElementById('bellPlayer');
        bp.src = document.getElementById('soundSelect').value;
        bp.loop = false;
        bp.play();
        setTimeout(() => { if(!bp.loop) { bp.pause(); bp.currentTime = 0; } }, 3000);
    }

    function addNewAlarm() {
        const t = document.getElementById('alarmTime').value;
        if (!t) return alert("è«‹é¸æ“‡æ™‚é–“");
        const n = document.getElementById('alarmName').value || "æé†’";
        const d = document.getElementById('alarmDuration').value;
        const s = document.getElementById('soundSelect').value;
        const sn = document.getElementById('soundSelect').options[document.getElementById('soundSelect').selectedIndex].text;
        const r = document.getElementById('repeatSelect').value;
        const pm = document.getElementById('playMode').value;

        alarms.push({ time: t, name: n, duration: d, sound: s, soundName: sn, repeat: r, playMode: pm, triggeredToday: false });
        saveData();
    }

    function saveData() {
        localStorage.setItem('savedAlarms', JSON.stringify(alarms));
        updateUI();
    }

    function updateUI() {
        const list = document.getElementById('alarmListArea');
        list.innerHTML = "";
        const rMap = { once: "ä¸€æ¬¡", daily: "æ¯å¤©", weekday: "å¹³æ—¥", weekend: "é€±æœ«", mon: "é€±ä¸€", tue: "é€±äºŒ", wed: "é€±ä¸‰", thu: "é€±å››", fri: "é€±äº”", sat: "é€±å…­", sun: "é€±æ—¥" };
        const pMap = { seq: "å…ˆèªéŸ³", sim: "åŒæ­¥" };

        alarms.sort((a,b) => a.time.localeCompare(b.time)).forEach((a, i) => {
            const div = document.createElement('div');
            div.className = `alarm-item ${a.triggeredToday ? 'done' : ''}`;
            div.innerHTML = `
                <button class="delete-btn" onclick="alarms.splice(${i},1);saveData();">âœ–</button>
                <span class="alarm-title">${a.name}</span>
                <span class="alarm-time">${a.time}</span>
                <div style="font-size:0.8rem; color:#666;">
                    ${a.triggeredToday ? '<span class="tag" style="background:#888;color:#fff;">å·²éŸ¿é ˜</span>' : ''}
                    <span class="tag">ğŸ” ${rMap[a.repeat]}</span>
                    <span class="tag">ğŸ“» ${pMap[a.playMode]}</span>
                    <span class="tag">ğŸµ ${a.soundName}</span>
                </div>
            `;
            list.appendChild(div);
        });
    }

// ä¿®æ”¹å¾Œçš„è§£é–å‡½æ•¸
let isAudioUnlocked = false; // æ–°å¢ä¸€å€‹æ¨™è¨˜ï¼Œè¨˜éŒ„æ˜¯å¦è§£é–é

function unlockAudio() {
    // å¦‚æœå·²ç¶“è§£é–éï¼Œæˆ–è€…é¬§é˜æ­£åœ¨éŸ¿ï¼Œå°±ä¸è¦å†åŸ·è¡Œè§£é–å‹•ä½œ
    if (isAudioUnlocked || document.body.classList.contains('flash-bg')) return;

    const bp = document.getElementById('bellPlayer');
    // åªæœ‰åœ¨éœéŸ³ä¸”æ²’è§£é–éçš„æƒ…æ³ä¸‹æ‰åšä¸€æ¬¡æ€§è§£é–
    isAudioUnlocked = true; 
    const originalSrc = bp.src;
    bp.volume = 0; // å…ˆéœéŸ³
    bp.play().then(() => {
        bp.pause();
        bp.volume = 1.0; // æ¢å¾©éŸ³é‡
        console.log("éŸ³è¨Šæ¬Šé™å·²é †åˆ©è§£é–");
    }).catch(e => {
        isAudioUnlocked = false; // å¦‚æœå¤±æ•—å‰‡ä¸‹æ¬¡é»æ“Šå†è©¦
    });
}
</script>
</body>
</html>

