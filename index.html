<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç­ç´šé¬§é˜ - å¯µç‰©ç™»å…¥å…¨åŠŸèƒ½ç‰ˆ</title>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f0f4f8; display: flex; justify-content: center; padding: 20px; }
        .container { background: white; width: 450px; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); text-align: center; }
        .login-box { padding: 20px; }
        #appContent { display: none; } /* ç™»å…¥å‰éš±è— */
        .clock { font-size: 3.5rem; font-weight: bold; color: #1a73e8; margin: 15px 0; background: #e8f0fe; border-radius: 15px; padding: 10px; }
        .setup-group { background: #fafafa; padding: 15px; border-radius: 15px; border: 1px solid #eee; text-align: left; }
        label { display: block; font-size: 0.85rem; color: #666; margin-top: 10px; }
        input, select, button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        .btn-main { background: #1a73e8; color: white; border: none; font-weight: bold; cursor: pointer; height: 45px; }
        .btn-add { background: #34a853; color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .btn-stop { background: #d93025; color: white; border: none; font-weight: bold; display: none; padding: 15px; font-size: 1.2rem; margin-top: 10px; }
        .sound-row { display: flex; gap: 5px; }
        .alarm-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; background: #fff; margin-top: 5px; border-radius: 8px; }
        .flash-bg { animation: alert-flash 0.5s infinite; }
        @keyframes alert-flash { 50% { background-color: #ff3333; color: white; } }
    </style>
</head>
<body onclick="initAudio()">

<div class="container">
    <div id="loginBox" class="login-box">
        <h2>æ­¡è¿ä½¿ç”¨ç­ç´šé¬§é˜</h2>
        <p>è«‹è¼¸å…¥æ‚¨çš„å¯µç‰©åç¨±ç™»å…¥</p>
        <input type="text" id="petNameInput" placeholder="ä¾‹å¦‚ï¼šå°èŠ±è²“">
        <button class="btn-main" style="margin-top:20px;" onclick="login()">é€²å…¥ç³»çµ±</button>
    </div>

    <div id="appContent">
        <h3 id="userTitle"></h3>
        <div id="liveClock" class="clock">00:00:00</div>
        
        <button id="authBtn" class="btn-main" style="background:#6c757d;" onclick="startMonitoring()">1. é»æ“Šå•Ÿå‹•ç›£æ§èˆ‡è²éŸ³</button>
        <button id="stopBtn" class="btn-stop" onclick="killAlarm()">ğŸ›‘ åœæ­¢éŸ¿éˆ´</button>

        <div class="setup-group">
            <label>1. é¬§é˜æ¨™é¡Œ (æ’­æ”¾èªéŸ³)ï¼š</label>
            <input type="text" id="alarmName" placeholder="ä¾‹å¦‚ï¼šæ‰“æƒæ™‚é–“åˆ°äº†">
            
            <label>2. è¨­å®šæ™‚é–“èˆ‡éŸ¿éˆ´ç§’æ•¸ï¼š</label>
            <div style="display:flex; gap:5px;">
                <input type="time" id="alarmTime" style="flex:2">
                <select id="alarmDuration" style="flex:1">
                    <option value="5">5ç§’</option>
                    <option value="10">10ç§’</option>
                    <option value="20">20ç§’</option>
                </select>
            </div>

            <label>3. é¸æ“‡éˆ´è²ï¼š</label>
            <div class="sound-row">
                <select id="soundSelect" style="flex:3">
                    <option value="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3">æ¨™æº–é›»å­éŸ³</option>
                    <option value="https://assets.mixkit.co/active_storage/sfx/1017/1017-preview.mp3">æ¸…è„†é˜è²</option>
                    <option value="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3">å¿«ç¯€å¥è­¦å ±</option>
                    <option value="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3">æŸ”å’Œæç¤ºéŸ³</option>
                    <option value="https://assets.mixkit.co/active_storage/sfx/1003/1003-preview.mp3">å¾©å¤é›»è©±éŸ³</option>
                </select>
                <button style="flex:1; background:#6c757d; color:white;" onclick="previewSound()">è©¦è½</button>
            </div>

            <button class="btn-add" onclick="addNewAlarm()">+ æ–°å¢é¬§é˜</button>
        </div>
        <div id="alarmListArea"></div>
        <button style="margin-top:20px; background:none; border:none; color:blue; text-decoration:underline; cursor:pointer;" onclick="location.reload()">åˆ‡æ›ä½¿ç”¨è€…</button>
    </div>
</div>

<audio id="bellPlayer" loop crossorigin="anonymous"></audio>

<script>
    let currentPet = "";
    let alarms = [];
    let isMonitoring = false;
    let autoStopTimer = null;

    // æ›´æ–°æ™‚é–“
    setInterval(() => {
        const now = new Date();
        const timeStr = now.toTimeString().split(' ')[0];
        document.getElementById('liveClock').innerText = timeStr;
        if (isMonitoring) {
            const currentHM = timeStr.substring(0, 5);
            alarms.forEach(a => {
                if (currentHM === a.time && !a.triggeredToday) executeAlarm(a);
                if (currentHM !== a.time) a.triggeredToday = false;
            });
        }
    }, 1000);

    function login() {
        currentPet = document.getElementById('petNameInput').value.trim();
        if (!currentPet) return alert("è«‹è¼¸å…¥åç¨±");
        
        document.getElementById('loginBox').style.display = "none";
        document.getElementById('appContent').style.display = "block";
        document.getElementById('userTitle').innerText = "ğŸ¾ ä½¿ç”¨è€…ï¼š" + currentPet;
        
        // è®€å–è©²å¯µç‰©å°ˆå±¬é¬§é˜
        alarms = JSON.parse(localStorage.getItem('alarms_' + currentPet)) || [];
        updateUI();
    }

    function initAudio() {
        const bp = document.getElementById('bellPlayer');
        bp.play().then(() => bp.pause()).catch(() => {});
    }

    function startMonitoring() {
        isMonitoring = true;
        document.getElementById('authBtn').innerText = "âœ… ç³»çµ±ç›£æ§ä¸­";
        document.getElementById('authBtn').style.background = "#34a853";
        // é ç†±èªéŸ³
        speak("ç³»çµ±å•Ÿå‹•");
    }

    function previewSound() {
        const bp = document.getElementById('bellPlayer');
        bp.src = document.getElementById('soundSelect').value;
        bp.loop = false;
        bp.play();
        setTimeout(() => { bp.pause(); bp.currentTime = 0; }, 3000);
    }

    function speak(text, callback) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'zh-TW';
        msg.volume = 1.0; 
        msg.rate = 0.8;
        if (callback) msg.onend = callback;
        window.speechSynthesis.speak(msg);
    }

    function addNewAlarm() {
        const t = document.getElementById('alarmTime').value;
        const n = document.getElementById('alarmName').value || "æ™‚é–“åˆ°äº†";
        const d = document.getElementById('alarmDuration').value;
        const s = document.getElementById('soundSelect').value;
        if (!t) return alert("è«‹è¼¸å…¥æ™‚é–“");
        
        alarms.push({ time: t, name: n, duration: d, sound: s, triggeredToday: false });
        localStorage.setItem('alarms_' + currentPet, JSON.stringify(alarms));
        updateUI();
    }

    function executeAlarm(alarm) {
        alarm.triggeredToday = true;
        document.body.classList.add('flash-bg');
        document.getElementById('stopBtn').style.display = "block";

        let count = 0;
        const repeatSpeak = () => {
            if (count < 3) {
                count++;
                speak(alarm.name, repeatSpeak);
            } else {
                const bp = document.getElementById('bellPlayer');
                bp.src = alarm.sound;
                bp.loop = true;
                bp.play();
                autoStopTimer = setTimeout(killAlarm, alarm.duration * 1000);
            }
        };
        repeatSpeak();
    }

    function killAlarm() {
        window.speechSynthesis.cancel();
        if (autoStopTimer) clearTimeout(autoStopTimer);
        const bp = document.getElementById('bellPlayer');
        bp.pause();
        bp.currentTime = 0;
        document.body.classList.remove('flash-bg');
        document.getElementById('stopBtn').style.display = "none";
    }

    function deleteAlarm(i) {
        alarms.splice(i, 1);
        localStorage.setItem('alarms_' + currentPet, JSON.stringify(alarms));
        updateUI();
    }

    function updateUI() {
        const container = document.getElementById('alarmListArea');
        container.innerHTML = "";
        alarms.sort((a,b) => a.time.localeCompare(b.time)).forEach((a, i) => {
            const div = document.createElement('div');
            div.className = 'alarm-item';
            div.innerHTML = `<span><b>${a.time}</b> - ${a.name}</span>
                             <button onclick="deleteAlarm(${i})" style="color:red; border:none; background:none; cursor:pointer; width:auto;">åˆªé™¤</button>`;
            container.appendChild(div);
        });
    }
</script>
</body>
</html>
