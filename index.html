<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç­ç´šé¬§é˜ç³»çµ± - è³ªæ„Ÿæš–è‰²ç‰ˆ</title>
    <style>
        /* 1. å…¨å±€è‰²å½©èˆ‡èƒŒæ™¯è¨­å®š */
        :root {
            --bg-color: #f5f2ed; /* æš–ç±³è‰²èƒŒæ™¯ï¼Œä¸å†å¤ªç™½ */
            --card-bg: rgba(255, 255, 255, 0.9);
            --primary-blue: #5a7d9a; /* è«è˜­è¿ªè— */
            --secondary-cream: #fdfaf5; /* å¥¶æ²¹è‰²è¨­å®šå€ */
            --alarm-border: #d1d9e6;
            --accent-green: #68a37d; /* è«è˜­è¿ªç¶  */
            --danger-red: #d93025;
        }

        body { 
            font-family: 'Microsoft JhengHei', sans-serif; 
            background-color: var(--bg-color); 
            display: flex; justify-content: center; padding: 20px; margin: 0; 
            transition: background 0.5s ease;
        }

        .container { 
            background: var(--card-bg); 
            width: 950px; max-width: 98vw; padding: 35px; 
            border-radius: 30px; 
            box-shadow: 20px 20px 60px #d1cfcb, -20px -20px 60px #ffffff; /* æ“¬ç‰©åŒ–é™°å½± */
            text-align: center; 
        }

        h2 { color: #4a4a4a; letter-spacing: 2px; margin-bottom: 25px; }

        /* 2. æ™‚é˜å€åŸŸå„ªåŒ– */
        .clock-container { 
            background: linear-gradient(145deg, #e6efff, #cfd9f0); 
            border-radius: 20px; padding: 20px; 
            display: inline-block; min-width: 380px; margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .clock { font-size: 4.2rem; font-weight: bold; color: var(--primary-blue); line-height: 1.1; text-shadow: 2px 2px 4px rgba(0,0,0,0.05); }
        .date-display { font-size: 1.5rem; color: #7a7a7a; font-weight: bold; margin-top: 8px; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 8px; }

        /* 3. æŒ‰éˆ•æ§åˆ¶å€èˆ‡å‹•ç•« */
        .control-panel { display: flex; justify-content: center; align-items: center; gap: 18px; margin-bottom: 30px; min-height: 75px; }
        
        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(217, 48, 37, 0.6); }
            70% { transform: scale(1.08); box-shadow: 0 0 0 20px rgba(217, 48, 37, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(217, 48, 37, 0); }
        }

        .btn-stop { 
            background: var(--danger-red); color: white; border: none; font-weight: bold; 
            display: none; padding: 0 40px; font-size: 1.5rem; height: 65px;
            border-radius: 18px; cursor: pointer; animation: pulse-red 1.5s infinite;
            transition: all 0.3s;
        }

        .btn-main { 
            background: var(--primary-blue); color: white; border: none; font-weight: bold; 
            cursor: pointer; height: 65px; font-size: 1.25rem; width: 340px; 
            border-radius: 18px; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 15px rgba(90, 125, 154, 0.3);
        }
        .btn-main:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(90, 125, 154, 0.4); }

        /* 4. è¨­å®šå€åŸŸæš–è‰²å„ªåŒ– */
        .setup-area { 
            background: var(--secondary-cream); 
            padding: 25px; border-radius: 20px; 
            border: 1px solid #efeae2; 
            margin-bottom: 35px; text-align: left; 
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.02);
        }
        .input-item label { font-size: 0.9rem; color: #8a8378; font-weight: bold; margin-bottom: 6px; }
        
        input, select { 
            padding: 12px; border-radius: 12px; border: 1px solid #e0dcd5; 
            font-size: 1rem; height: 50px; background: white; color: #555;
            transition: border 0.3s;
        }
        input:focus, select:focus { border-color: var(--primary-blue); outline: none; }

        .btn-add { 
            background: var(--accent-green); color: white; border: none; font-weight: bold; 
            cursor: pointer; padding: 0 30px; border-radius: 12px;
            transition: all 0.3s;
        }
        .btn-add:hover { background: #568a68; transform: scale(1.02); }

        .btn-listen { background: #9fa8ab; color: white; border: none; cursor: pointer; padding: 0 20px; font-size: 0.95rem; border-radius: 12px; }

        /* 5. é¬§é˜å¡ç‰‡è³ªæ„Ÿå„ªåŒ– */
        #alarmListArea { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 25px; }
        
        .alarm-item { 
            text-align: left; padding: 25px; 
            background: linear-gradient(135deg, #ffffff, #f9fbff);
            border: 1px solid var(--alarm-border); 
            border-radius: 22px; position: relative; 
            transition: all 0.4s ease;
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .alarm-item:hover { transform: translateY(-8px); box-shadow: 0 12px 30px rgba(0,0,0,0.1); border-color: var(--primary-blue); }

        .alarm-title { font-size: 1.8rem; font-weight: 800; color: #3d3d3d; margin-bottom: 8px; display: block; line-height: 1.2; }
        .alarm-time { font-size: 1.7rem; font-weight: bold; color: var(--primary-blue); margin-bottom: 12px; display: block; }
        
        .tag { 
            display: inline-block; background: #f0f2f5; color: #606f7b; 
            padding: 5px 12px; border-radius: 10px; font-size: 0.85rem; 
            margin-right: 6px; margin-top: 8px; border: 1px solid #e1e5eb; 
        }
        .alarm-item.done { background: #efefef; opacity: 0.6; border-color: #d1d1d1; }
        
        .delete-btn { position: absolute; right: 15px; top: 15px; color: #cbd5e0; border: none; background: none; cursor: pointer; font-size: 1.6rem; transition: color 0.3s; }
        .delete-btn:hover { color: var(--danger-red); }
    </style>
</head>
<body onclick="unlockAudio()">

<div class="container">
    <h2>â˜• ç­ç´šé¬§é˜ç³»çµ±</h2>
    
    <div class="clock-container">
        <div id="liveClock" class="clock">00:00:00</div>
        <div id="liveDate" class="date-display">0000/00/00 æ˜ŸæœŸä¸€</div>
    </div>
    
    <div class="control-panel">
        <button id="stopBtn" class="btn-stop" onclick="killAlarm()">ğŸ›‘ åœæ­¢éŸ¿éˆ´</button>
        <button id="authBtn" class="btn-main" onclick="startMonitoring()">1. é»æ“Šå•Ÿå‹•ç›£æ§ç³»çµ±</button>
    </div>

    <div class="setup-area">
        <div class="setup-row">
            <div class="input-item" style="width: 200px;"> <label>é¬§é˜æ¨™é¡Œ</label>
                <input type="text" id="alarmName" placeholder="ä¾‹å¦‚ï¼šæ‰“æƒæ™‚é–“">
            </div>
            <div class="input-item" style="flex: 1.5;"> <label>æ™‚é–“èˆ‡æ’­æ”¾æ–¹å¼</label>
                <div style="display: flex; gap: 8px;">
                    <input type="time" id="alarmTime" style="width: 160px;"> 
                    <select id="playMode" style="flex: 1;"> 
                        <option value="seq">å…ˆèªéŸ³ â” éˆ´è²</option>
                        <option value="sim">èªéŸ³/éˆ´è²åŒæ­¥</option>
                    </select>
                </div>
            </div>
            <div class="input-item" style="width: 130px;">
                <label>é‡è¤‡é€±æœŸ</label>
                <select id="repeatSelect">
                    <option value="once">ä¸€æ¬¡</option><option value="daily">æ¯å¤©</option>
                    <option value="weekday">å¹³æ—¥</option><option value="weekend">é€±æœ«</option>
                    <option value="mon">é€±ä¸€</option><option value="tue">é€±äºŒ</option>
                    <option value="wed">é€±ä¸‰</option><option value="thu">é€±å››</option>
                    <option value="fri">é€±äº”</option><option value="sat">é€±å…­</option><option value="sun">é€±æ—¥</option>
                </select>
            </div>
        </div>

        <div class="setup-row">
            <div class="input-item" style="width: 180px;">
                <label>é¸æ“‡éˆ´è²</label>
                <select id="soundSelect">
                    <option value="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3">æ¨™æº–é›»å­éŸ³</option>
                    <option value="https://assets.mixkit.co/active_storage/sfx/1017/1017-preview.mp3">æ¸…è„†é˜è²</option>
                    <option value="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3">å¿«ç¯€å¥è­¦å ±</option>
                    <option value="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3">æŸ”å’Œæç¤ºéŸ³</option>
                    <option value="https://assets.mixkit.co/active_storage/sfx/1003/1003-preview.mp3">å¾©å¤é›»è©±éŸ³</option>
                </select>
            </div>
            <div class="input-item" style="width: 140px;">
                <label>æŒçºŒæ™‚é–“</label>
                <select id="alarmDuration">
                    <option value="5">æ’­æ”¾ 5 ç§’</option>
                    <option value="10">æ’­æ”¾ 10 ç§’</option>
                    <option value="20">æ’­æ”¾ 20 ç§’</option>
                    <option value="30">æ’­æ”¾ 30 ç§’</option>
                </select>
            </div>
            <button class="btn-listen" onclick="previewSound()">ğŸ”Š è©¦è½</button>
            <button class="btn-add" style="flex: 1;" onclick="addNewAlarm()">+ æ–°å¢é¬§é˜</button>
        </div>
    </div>

    <div id="alarmListArea"></div>
</div>

<audio id="bellPlayer" loop crossorigin="anonymous"></audio>

<script>
    /* åŠŸèƒ½å®Œå…¨ä¸æ›´å‹•ï¼Œç¶­æŒåŠŸèƒ½ç¢ºèªç‰ˆé‚è¼¯ */
    let alarms = JSON.parse(localStorage.getItem('savedAlarms')) || [];
    let isMonitoring = false;
    let autoStopTimer = null;
    let lastDate = new Date().getDate();
    let isAudioUnlocked = false;

    setInterval(() => {
        const now = new Date();
        const timeStr = now.toTimeString().split(' ')[0];
        if(document.getElementById('liveClock')) document.getElementById('liveClock').innerText = timeStr;
        const days = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
        const dateStr = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')} ${days[now.getDay()]}`;
        if(document.getElementById('liveDate')) document.getElementById('liveDate').innerText = dateStr;

        if (now.getDate() !== lastDate) {
            lastDate = now.getDate();
            alarms.forEach(a => a.triggeredToday = false);
            saveData();
        }
        if (isMonitoring) {
            const currentHM = timeStr.substring(0, 5);
            alarms.forEach((a, index) => {
                if (currentHM === a.time && !a.triggeredToday && isCorrectDay(a.repeat, now.getDay())) {
                    startAlarm(a, index);
                }
            });
        }
    }, 1000);

    function isCorrectDay(mode, day) {
        if (mode === 'once' || mode === 'daily') return true;
        if (mode === 'weekday') return day >= 1 && day <= 5;
        if (mode === 'weekend') return day === 0 || day === 6;
        const map = { sun: 0, mon: 1, tue: 2, wed: 3, thu: 4, fri: 5, sat: 6 };
        return map[mode] === day;
    }

    function unlockAudio() {
        if (isAudioUnlocked) return;
        const bp = document.getElementById('bellPlayer');
        isAudioUnlocked = true;
        bp.volume = 0; 
        bp.play().then(() => { bp.pause(); bp.volume = 1.0; }).catch(() => { isAudioUnlocked = false; });
    }

    function speak(text, callback) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'zh-TW';
        msg.volume = 1.0; 
        if (callback) msg.onend = callback;
        window.speechSynthesis.speak(msg);
    }

    function startMonitoring() {
        isMonitoring = true;
        const btn = document.getElementById('authBtn');
        btn.innerText = "âœ… ç›£æ§é‹è¡Œä¸­";
        btn.style.background = "#68a37d"; /* æ›æˆè«è˜­è¿ªç¶  */
        updateUI();
        speak("ç³»çµ±å•Ÿå‹•");
    }

    function startAlarm(alarm, index) {
        alarm.triggeredToday = true;
        updateUI(); 
        document.getElementById('stopBtn').style.display = "block";
        const bp = document.getElementById('bellPlayer');
        bp.src = alarm.sound;
        bp.volume = 1.0;
        bp.loop = true;
        let count = 0;
        const playVoice = () => {
            if (count < 3) { count++; speak(alarm.name, playVoice); } 
            else if (alarm.playMode === 'seq') { bp.play(); setTimer(alarm, index); }
        };
        if (alarm.playMode === 'sim') { bp.play(); playVoice(); setTimer(alarm, index); } 
        else { playVoice(); }
    }

    function setTimer(alarm, index) {
        if (autoStopTimer) clearTimeout(autoStopTimer);
        autoStopTimer = setTimeout(() => {
            killAlarm();
            if (alarm.repeat === 'once') { alarms.splice(index, 1); }
            saveData();
        }, alarm.duration * 1000);
    }

    function killAlarm() {
        window.speechSynthesis.cancel();
        if (autoStopTimer) clearTimeout(autoStopTimer);
        const bp = document.getElementById('bellPlayer');
        bp.pause();
        bp.currentTime = 0;
        document.getElementById('stopBtn').style.display = "none";
    }

    function previewSound() {
        const bp = document.getElementById('bellPlayer');
        bp.src = document.getElementById('soundSelect').value;
        bp.volume = 1.0;
        bp.loop = false;
        bp.play();
        setTimeout(() => { if(!bp.loop) { bp.pause(); bp.currentTime = 0; } }, 3000);
    }

    function addNewAlarm() {
        const t = document.getElementById('alarmTime').value;
        if (!t) return alert("è«‹é¸æ“‡æ™‚é–“");
        const n = document.getElementById('alarmName').value || "æé†’";
        const d = document.getElementById('alarmDuration').value;
        const s = document.getElementById('soundSelect').value;
        const sn = document.getElementById('soundSelect').options[document.getElementById('soundSelect').selectedIndex].text;
        const r = document.getElementById('repeatSelect').value;
        const pm = document.getElementById('playMode').value;
        alarms.push({ time: t, name: n, duration: d, sound: s, soundName: sn, repeat: r, playMode: pm, triggeredToday: false });
        saveData();
    }

    function saveData() {
        localStorage.setItem('savedAlarms', JSON.stringify(alarms));
        updateUI();
    }

    function updateUI() {
        const list = document.getElementById('alarmListArea');
        list.innerHTML = "";
        const rMap = { once: "ä¸€æ¬¡", daily: "æ¯å¤©", weekday: "å¹³æ—¥", weekend: "é€±æœ«", mon: "é€±ä¸€", tue: "é€±äºŒ", wed: "é€±ä¸‰", thu: "é€±å››", fri: "é€±äº”", sat: "é€±å…­", sun: "é€±æ—¥" };
        const pMap = { seq: "å…ˆèªéŸ³", sim: "åŒæ­¥" };
        alarms.sort((a,b) => a.time.localeCompare(b.time)).forEach((a, i) => {
            const div = document.createElement('div');
            div.className = `alarm-item ${a.triggeredToday ? 'done' : ''}`;
            div.innerHTML = `
                <button class="delete-btn" onclick="alarms.splice(${i},1);saveData();">âœ–</button>
                <span class="alarm-title">${a.name}</span>
                <span class="alarm-time">${a.time}</span>
                <div>
                    ${a.triggeredToday ? '<span class="tag" style="background:#888;color:#fff;border:none;">âœ… ä»Šæ—¥å·²éŸ¿</span>' : ''}
                    <span class="tag">ğŸ” ${rMap[a.repeat]}</span>
                    <span class="tag">ğŸ“» ${pMap[a.playMode]}</span>
                    <span class="tag">ğŸµ ${a.soundName}</span>
                    <span class="tag">â³ ${a.duration}ç§’</span>
                </div>
            `;
            list.appendChild(div);
        });
    }
    updateUI();
</script>
</body>
</html>
